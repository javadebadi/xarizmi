import pytest

from xarizmi.candlestick import CandlestickChart
from xarizmi.ta.obv import OBVIndicator


class TestOBVIndicator:

    def test(
        self, btc_usdt_monthly_data: list[dict[str, int | float]]
    ) -> None:
        excepted = [
            4.10488336e02,
            8.49245069e02,
            -8.23336839e03,
            3.04837318e03,
            -5.59358348e03,
            1.80281645e03,
            -5.86569107e03,
            -1.10652423e04,
            -5.58389011e03,
            -1.14197918e04,
            -1.75918216e04,
            -2.23981826e04,
            -3.11858839e04,
            -4.12306156e04,
            -4.46184233e04,
            -4.19271804e04,
            -3.67233147e04,
            -2.45456310e04,
            -9.53186908e03,
            1.10723889e04,
            -2.34827955e05,
            -5.53792784e05,
            -6.17875608e05,
            -5.94985168e05,
            -6.17383284e05,
            -6.37269139e05,
            -5.94647677e05,
            -6.34076430e05,
            -7.34813590e05,
            -6.57787633e05,
            -5.44530423e05,
            -6.13037727e05,
            -5.21085883e05,
            -3.94120911e05,
            -5.10515787e05,
            -4.52623407e05,
            -3.71810308e05,
            -3.04839845e05,
            -1.49872175e05,
            -4.36449377e04,
            8.29955382e04,
            -7.89834785e04,
            -3.57483207e05,
            -5.91664659e05,
            -4.42027385e05,
            -2.21576038e05,
            -3.93363258e05,
            -1.30687856e05,
            -3.47780209e05,
            -6.12734874e05,
            -9.18807974e05,
            -6.65540487e05,
            -4.34678584e05,
            -8.23697249e05,
            -1.30993570e06,
            -1.83001096e06,
            -1.47061957e06,
            -1.72463371e06,
            -2.32055732e06,
            -1.87165957e06,
            -2.35689641e06,
            -2.50216833e06,
            -2.29989533e06,
            -2.14712448e06,
            -1.91998963e06,
            -1.78022320e06,
            -1.88448888e06,
            -1.72681575e06,
            -1.80993108e06,
            -1.88452828e06,
            -1.81989103e06,
            -1.73503760e06,
            -1.65602287e06,
            -1.55844706e06,
            -1.43399571e06,
            -1.27805028e06,
            -1.03546289e06,
            -1.13724023e06,
            -1.06540455e06,
            -1.05174708e06,
        ]

        c = CandlestickChart.model_validate({"candles": btc_usdt_monthly_data})

        obv_indicator = OBVIndicator(candlestick_chart=c, volume="amount")
        actual = obv_indicator.compute()

        assert actual == pytest.approx(excepted)
